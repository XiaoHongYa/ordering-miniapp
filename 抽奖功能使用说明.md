# 抽奖功能使用说明

## 功能概述

为点餐小程序新增了一个简单的抽奖转盘功能，用户可以通过点击菜单页面右下角的悬浮球进入抽奖页面。

---

## 已完成的工作

### 1. ✅ 数据表创建

已在飞书多维表格中创建两张表：

- **抽奖奖品表**: https://hx9pg0opel7.feishu.cn/base/WcmNbFvM5aRWdVsegQZcLa9gnme?table=tblHuGhJsKPApeMz
- **抽奖记录表**: https://hx9pg0opel7.feishu.cn/base/WcmNbFvM5aRWdVsegQZcLa9gnme?table=tblBQUrvX5WuwqB5

### 2. ✅ 环境变量配置

已在 `.env` 和 `.dev.vars` 中添加：
```env
VITE_FEISHU_PRIZE_TABLE_ID=tblHuGhJsKPApeMz
VITE_FEISHU_LOTTERY_RECORD_TABLE_ID=tblBQUrvX5WuwqB5
```

### 3. ✅ API 接口实现

在 [src/api/feishu.js](src/api/feishu.js) 中新增 3 个函数：

- `getPrizes()` - 获取奖品列表
- `drawLottery(username)` - 执行抽奖
- `getLotteryRecords(username)` - 获取用户抽奖记录

### 4. ✅ 前端页面实现

- **抽奖页面**: [src/views/Lottery.vue](src/views/Lottery.vue)
  - SVG 绘制的圆形转盘
  - 旋转动画（3秒）
  - 中奖弹窗
  - 我的奖品列表

- **菜单页面悬浮球**: [src/views/Menu.vue](src/views/Menu.vue)
  - 右下角紫色渐变悬浮球
  - 脉冲动画效果
  - 点击跳转到抽奖页面

### 5. ✅ 路由配置

在 [src/router/index.js](src/router/index.js) 中新增：
```javascript
{
  path: '/lottery',
  name: 'Lottery',
  component: () => import('@/views/Lottery.vue'),
  meta: { title: '幸运抽奖', requiresAuth: true }
}
```

---

## 使用流程

### 1. 添加奖品数据

在飞书多维表格的"抽奖奖品表"中添加奖品：

| prize_name | prize_icon | win_probability | sort_order | status |
|-----------|-----------|-----------------|-----------|--------|
| 5元券 | 🎁 | 10 | 1 | 启用 |
| 10元券 | 💰 | 8 | 2 | 启用 |
| 免费米饭 | 🍚 | 12 | 3 | 启用 |
| 免费饮料 | 🥤 | 15 | 4 | 启用 |
| 再接再厉 | 💪 | 25 | 5 | 启用 |
| 谢谢参与 | 😊 | 30 | 6 | 启用 |

**注意**：
- `win_probability`（中奖概率）的总和应该等于 100
- `prize_icon` 可以使用 emoji 表情
- `sort_order` 决定奖品在转盘上的顺序

### 2. 启动项目

```bash
npm run dev
```

### 3. 测试抽奖功能

1. 登录小程序
2. 进入"点餐菜单"页面
3. 点击右下角的紫色悬浮球（显示"🎁 抽奖"）
4. 进入抽奖页面
5. 点击"开始抽奖"按钮
6. 等待转盘旋转（3秒）
7. 查看中奖结果
8. 点击"我的奖品"查看抽奖记录
9. 点击左上角返回按钮回到菜单页面

---

## 功能特点

### 🎯 简单易用
- 只有 2 张数据表，共 13 个字段
- 没有复杂的库存、有效期等管理
- 纯概率抽奖，快速演示

### 🎨 界面美观
- SVG 绘制的圆形转盘
- 渐变色背景
- 流畅的旋转动画
- 脉冲效果的悬浮球

### 📊 数据完整
- 记录所有抽奖历史
- 冗余存储奖品信息（防止历史数据错乱）
- 按时间倒序显示

---

## 技术实现

### 抽奖算法（权重随机）

```javascript
// 1. 获取所有启用的奖品
const prizes = [
  { name: '5元券', probability: 10 },
  { name: '10元券', probability: 8 },
  // ...
]

// 2. 生成 0-100 的随机数
const random = Math.random() * 100

// 3. 根据概率区间判断中奖
let cumulative = 0
for (const prize of prizes) {
  cumulative += prize.probability
  if (random < cumulative) {
    return prize  // 中奖
  }
}
```

### 转盘绘制

使用 SVG `<path>` 元素绘制扇形：
- 根据奖品数量计算每个扇形的角度
- 使用三角函数计算坐标
- 动态生成路径字符串

### 旋转动画

使用 CSS `transform: rotate()` 和 `transition`：
```css
.wheel {
  transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
}
```

---

## 扩展建议

如果后续需要增强功能，可以考虑：

### 1. 抽奖次数限制
- 每日限制抽奖次数
- 单个用户总抽奖次数限制

### 2. 奖品库存管理
- 添加 `total_quantity`（总库存）
- 添加 `remaining_quantity`（剩余库存）
- 中奖后自动扣减库存

### 3. 奖品有效期
- 添加 `valid_days`（有效天数）
- 在抽奖记录中记录过期时间
- 区分"未使用"、"已使用"、"已过期"

### 4. 优惠券核销
- 生成唯一优惠券码
- 在下单时选择可用优惠券
- 验证并扣减订单金额

### 5. 多种奖品类型
- 优惠券（抵扣金额）
- 菜品（免费赠送）
- 积分（累计兑换）

---

## 常见问题

### Q1: 转盘不显示奖品？

**原因**: 飞书多维表格中没有添加奖品数据

**解决**:
1. 打开飞书多维表格的"抽奖奖品表"
2. 添加至少 1 个奖品
3. 确保 `status` 字段为"启用"

### Q2: 点击抽奖没反应？

**原因**: 可能未登录或网络问题

**解决**:
1. 确保已登录
2. 打开浏览器控制台查看错误
3. 检查网络连接

### Q3: 概率不准确？

**原因**: 所有奖品的概率之和不等于 100

**解决**:
1. 检查"抽奖奖品表"中所有启用奖品的 `win_probability` 值
2. 确保总和 = 100

### Q4: 历史记录显示错误？

**原因**: 奖品表中的数据被修改了

**解决**:
- 这是正常的，因为抽奖记录表采用了冗余存储设计
- 冗余存储保证了历史记录的准确性
- 即使奖品表修改，历史记录也不会变

---

## 部署到 Cloudflare Pages

### 1. 更新 Cloudflare Pages 环境变量

登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)，添加：

```
VITE_FEISHU_PRIZE_TABLE_ID=tblHuGhJsKPApeMz
VITE_FEISHU_LOTTERY_RECORD_TABLE_ID=tblBQUrvX5WuwqB5
```

### 2. 重新部署

```bash
git add .
git commit -m "新增抽奖功能"
git push origin main
```

Cloudflare Pages 会自动重新部署。

---

## 总结

✅ **已实现的核心功能**：
1. 奖品配置管理
2. 概率抽奖算法
3. 转盘UI和动画
4. 抽奖记录查看
5. 菜单页面悬浮球入口

✅ **技术栈**：
- Vue 3 + Vite
- Vant 组件库
- 飞书多维表格 API
- SVG 转盘绘制
- CSS3 动画

✅ **部署支持**：
- Cloudflare Pages
- Netlify

🎉 **抽奖功能已经可以使用了！**
