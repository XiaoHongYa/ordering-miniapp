# 菜品图片备用方案说明

## 功能概述

实现了菜品图片的双重来源支持，支持从飞书多维表格的 URL 字段和附件字段加载图片，并提供自动降级机制。

## 实现方案

### 1. 数据层（feishu.js）

#### 附件字段解析
- 在 `parseFieldValue` 函数中添加了对附件字段的解析支持
- 附件字段格式：`[{"file_token":"xxx","name":"xxx","tmp_url":"xxx","url":"xxx"}]`
- 解析逻辑：优先使用 `tmp_url`，如果没有则使用 `url`

#### 菜品数据结构
- 在 `getDishes` 函数返回的数据中添加了 `image_url_v2` 字段
- `image_url`：原有的 URL 字段（优先级1）
- `image_url_v2`：新增的附件字段（优先级2）

### 2. 状态层（cart.js）

#### 购物车数据扩展
- 在添加商品到购物车时，同时保存 `image_url` 和 `image_url_v2` 两个字段
- 确保购物车页面也能使用备用图片

### 3. 展示层（Menu.vue & Cart.vue）

#### 图片加载策略
1. **初始加载**：优先使用 `image_url`
   - 如果 `image_url` 有值，使用 `image_url`
   - 如果 `image_url` 无值，使用 `image_url_v2`
   - 如果都无值，使用默认图片 `/default-dish.png`

2. **错误降级**：当图片加载失败时（404或其他错误）
   - 使用 `@error` 事件监听图片加载错误
   - 自动切换到 `image_url_v2`
   - 如果 `image_url_v2` 也失败，使用默认图片
   - 使用 `failedImages` Set 记录加载失败的商品ID，避免重复尝试

#### 关键方法
- `getDishImageUrl(dish)` / `getItemImageUrl(item)`：获取当前应该使用的图片 URL
- `handleImageError(event, dish/item)`：处理图片加载错误，自动切换到备用图片

## 使用场景

### 场景1：image_url 可用
- 菜品表中 `image_url` 字段有值且图片可以正常访问
- 结果：直接显示 `image_url` 的图片

### 场景2：image_url 不可用，image_url_v2 可用
- 菜品表中 `image_url` 字段为空，或图片加载失败（404等）
- 菜品表中 `image_url_v2` 字段有附件
- 结果：自动切换显示 `image_url_v2` 的图片

### 场景3：两个字段都不可用
- 菜品表中两个字段都为空，或都加载失败
- 结果：显示默认图片 `/default-dish.png`

## 附件字段说明

### 飞书附件字段特点
1. **永久性**：附件上传到飞书后，会生成永久的访问链接
2. **权限控制**：附件的访问权限与多维表格的访问权限一致
3. **自动托管**：附件由飞书云存储托管，无需自己维护图片服务器

### 附件URL格式
- `tmp_url`：临时URL，通常有效期较长
- `url`：永久URL
- 两个URL都可以直接在 `<img>` 标签中使用

## 优势

1. **灵活性**：支持两种图片来源，可以根据实际情况选择使用
2. **可靠性**：当主图片无法访问时，自动降级到备用图片
3. **用户体验**：图片切换过程对用户透明，无需刷新页面
4. **易维护**：附件托管在飞书，无需额外的图片服务器维护成本

## 技术细节

### 图片加载错误处理
```javascript
// 使用 @error 事件监听图片加载失败
<img @error="handleImageError($event, dish)" />

// 在错误处理函数中自动切换到备用图片
const handleImageError = (event, dish) => {
  if (!failedImages.value.has(dish.id)) {
    failedImages.value.add(dish.id)
    if (dish.image_url_v2 && event.target.src !== dish.image_url_v2) {
      event.target.src = dish.image_url_v2
    } else {
      event.target.src = '/default-dish.png'
    }
  }
}
```

### 避免无限循环
- 使用 `failedImages` Set 记录已经失败的图片
- 确保每个图片只尝试加载一次主图和一次备用图
- 避免在备用图也失败时再次触发主图加载

## 配置要求

### 飞书多维表格配置
1. 在菜品表中添加 `image_url_v2` 字段
2. 字段类型选择"附件"
3. 上传图片到该字段

### 前端配置
- 无需额外配置，代码会自动识别和处理附件字段

## 注意事项

1. **性能考虑**：图片加载失败会触发备用图片加载，可能会有短暂的延迟
2. **网络优化**：建议在飞书后台上传压缩后的图片，提高加载速度
3. **权限设置**：确保多维表格的访问权限设置正确，否则用户可能无法访问附件
4. **默认图片**：确保项目中有 `/default-dish.png` 作为最终的兜底图片
