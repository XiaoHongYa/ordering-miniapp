# 飞书Wiki多维表格权限配置指南

## 🔍 问题诊断

如果在运行测试脚本时遇到以下错误:

```
❌ 请求异常: { code: 91402, msg: 'NOTEXIST', data: {} }
```

这说明:**应用没有访问Wiki多维表格的权限**。需要按照以下步骤配置权限。

---

## ✅ 解决方案

### 步骤1: 配置飞书应用权限

1. 访问[飞书开放平台](https://open.feishu.cn/)
2. 进入你的应用管理页面
3. 点击左侧菜单 **权限管理**
4. 确保已开通以下权限:

   **必需权限:**
   - ✅ `bitable:app` - 查看、评论、编辑和管理多维表格
   - ✅ `wiki:wiki` - 访问知识空间信息

   **推荐权限:**
   - `bitable:app:readonly` - 查看多维表格(如果只需读取)
   - `wiki:wiki:readonly` - 只读访问Wiki(如果只需读取)

5. 保存权限配置

---

### 步骤2: 将应用添加为Wiki协作者 ⭐ **关键步骤**

这是最关键的一步!即使应用有权限,如果没有被添加为Wiki协作者,也无法访问Wiki中的多维表格。

#### 方法1: 通过Wiki页面添加(推荐)

1. 打开你的Wiki知识库页面:
   ```
   https://hx9pg0opel7.feishu.cn/wiki/Einjw3fPoiw0UKk4WVOcu6l6nLe
   ```

2. 点击页面右上角的 **"..."** (更多) 按钮

3. 选择 **"协作"** 或 **"权限设置"**

4. 在协作者列表中,点击 **"添加协作者"**

5. 搜索并添加你的应用/机器人:
   - 应用名称可能显示为应用的名称
   - 或者搜索 App ID: `cli_a9870d3a78b4d00c`

6. 设置权限为 **"可编辑"** 或 **"可查看"**(根据需求)

7. 保存设置

#### 方法2: 通过应用后台配置

如果应用是自己创建的:

1. 在飞书管理后台
2. 找到 **应用与机器人** 设置
3. 将应用添加到目标Wiki的可访问列表中

---

### 步骤3: 验证配置

运行测试脚本验证配置是否成功:

```bash
node scripts/test-feishu-api.js
```

**成功的输出应该包含:**

```
✅ Token获取成功
✅ 成功获取 X 个字段:
   1. username (文本)
   2. password (文本)
   3. name (文本)
   4. status (单选)

✅ 成功查询到 X 条记录
```

---

## 🔧 配置检查清单

在配置完成后,请检查以下几点:

### 1. 应用权限检查
- [ ] 应用有 `bitable:app` 权限
- [ ] 应用有 `wiki:wiki` 权限
- [ ] 权限已经保存并生效

### 2. Wiki协作者检查
- [ ] 应用已被添加为Wiki协作者
- [ ] 协作权限至少为"可查看"(如果需要写入则为"可编辑")
- [ ] 协作者列表中能看到该应用

### 3. 配置文件检查
- [ ] `.env` 文件中的 `VITE_FEISHU_APP_TOKEN` 是正确的Wiki Token
- [ ] Wiki Token 从URL中提取: `https://xxx.feishu.cn/wiki/[这里是Token]`
- [ ] 所有 Table ID 都是正确的

---

## 🎯 常见问题

### Q1: 如何确认Wiki Token是否正确?

**A:** Wiki Token应该是Wiki URL中 `/wiki/` 后面的部分。

```
Wiki URL: https://hx9pg0opel7.feishu.cn/wiki/Einjw3fPoiw0UKk4WVOcu6l6nLe
                                                    ↑ 这部分是Wiki Token
```

在我们的项目中应该是: `Einjw3fPoiw0UKk4WVOcu6l6nLe`

### Q2: 添加协作者后还是报错怎么办?

**A:** 可能的原因:
1. 权限刚配置,还没生效,等待1-2分钟
2. 需要重新获取 tenant_access_token
3. 检查是否给了正确的权限(至少需要"可查看")

### Q3: 如何找到我的应用?

**A:** 在添加协作者时:
- 搜索应用名称
- 或搜索 App ID: `cli_a9870d3a78b4d00c`
- 应用通常会显示一个机器人图标

### Q4: 为什么 code: 91402, msg: 'NOTEXIST'?

**A:** 这个错误表示:
- 应用能访问飞书API
- 能找到Wiki
- 但没有权限访问Wiki中的表格

**解决方法:** 必须将应用添加为Wiki协作者(步骤2)

---

## 📋 权限配置对比

| 错误代码 | 错误信息 | 原因 | 解决方法 |
|---------|---------|------|---------|
| 1254041 | TableIdNotFound | Wiki Token错误 | 修正 `.env` 中的 `VITE_FEISHU_APP_TOKEN` |
| 91402 | NOTEXIST | 未添加为协作者 | 将应用添加为Wiki协作者 |
| 99991663 | 无权限 | 缺少应用权限 | 在应用后台开通 `bitable:app` 和 `wiki:wiki` 权限 |
| 0 | 成功 | ✅ 配置正确 | 无需操作 |

---

## 🎉 配置成功后

配置成功后,你应该能够:

1. ✅ 读取用户数据 - 登录功能正常
2. ✅ 读取公告 - 首页公告显示
3. ✅ 读取分类和菜品 - 菜单页面正常
4. ✅ 写入订单数据 - 下单功能正常

---

## 📞 需要帮助?

如果按照以上步骤操作后仍然有问题,请检查:

1. 飞书应用的状态是否为"已启用"
2. 是否使用了正确的 App ID 和 App Secret
3. 网络是否能正常访问 `https://open.feishu.cn`
4. 查看飞书开放平台的[故障排查文档](https://open.feishu.cn/document/)

---

最后更新: 2025-11-11
