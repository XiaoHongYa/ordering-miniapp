# 生产环境部署指南

## 问题诊断

当前生产环境登录报错: `tenant_access_token获取失败: Error: invalid param`

**根本原因**: 生产服务器没有配置 API 代理,导致前端无法正确调用飞书 API。

## 解决方案

### 方案一: 配置 Nginx 反向代理(推荐)

1. **复制 nginx 配置文件**

项目根目录已提供 `nginx.conf` 配置文件模板。

2. **修改配置文件中的路径**

将 `nginx.conf` 中的 `/path/to/dist` 改为实际的 dist 目录路径:

```nginx
root /path/to/dist;  # 改为实际路径,例如: /var/www/ordering-app/dist
```

3. **应用 nginx 配置**

```bash
# 如果是独立的配置文件
sudo cp nginx.conf /etc/nginx/conf.d/ordering-app.conf

# 或者将配置内容添加到主配置文件
sudo nano /etc/nginx/nginx.conf

# 测试配置是否正确
sudo nginx -t

# 重新加载配置
sudo nginx -s reload
```

### 方案二: 配置 Apache 反向代理

如果使用 Apache,创建或修改虚拟主机配置:

```apache
<VirtualHost *:9000>
    DocumentRoot /path/to/dist

    <Directory /path/to/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA路由支持
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # API代理配置
    ProxyRequests Off
    ProxyPreserveHost Off

    <Location /api/>
        ProxyPass https://open.feishu.cn/
        ProxyPassReverse https://open.feishu.cn/

        # 修改请求头
        RequestHeader set Host "open.feishu.cn"

        # CORS支持
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    </Location>
</VirtualHost>
```

启用必要的模块并重启:

```bash
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod headers
sudo a2enmod rewrite
sudo systemctl restart apache2
```

## 验证配置

配置完成后,可以通过以下方式验证:

1. **测试 API 代理**

在浏览器控制台执行:

```javascript
fetch('/api/open-apis/auth/v3/tenant_access_token/internal', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    app_id: 'cli_a9870d3a78b4d00c',
    app_secret: 'ojOTmuycdC2NiCjCCGDechvcGU4PCtqB'
  })
})
.then(r => r.json())
.then(d => console.log(d))
```

如果返回包含 `tenant_access_token` 的对象,说明代理配置成功。

2. **重新尝试登录**

打开 `http://172.16.38.135:9000/login`,使用测试账号登录,应该可以正常登录。

## 关键配置说明

### Nginx 配置关键点

1. **proxy_pass**: 必须以 `/` 结尾,确保路径正确转发
2. **proxy_set_header Host**: 必须设置为目标服务器域名 `open.feishu.cn`
3. **try_files**: 支持 Vue Router 的 history 模式

### 常见问题

**Q: 为什么开发环境正常,生产环境报错?**

A: 开发环境使用 Vite 开发服务器,自动处理代理。生产环境是静态文件部署,需要 Web 服务器(nginx/apache)配置代理。

**Q: 可以直接从前端调用 https://open.feishu.cn 吗?**

A: 不可以。浏览器的 CORS 策略会阻止跨域请求,必须通过服务器代理。

**Q: 配置后仍然报错怎么办?**

A: 检查以下几点:
1. nginx/apache 是否正确重启
2. 服务器是否能访问 `https://open.feishu.cn` (检查防火墙)
3. 查看 nginx/apache 错误日志: `sudo tail -f /var/log/nginx/error.log`

## 安全建议

生产环境建议:

1. **使用 HTTPS**: 配置 SSL 证书保护数据传输
2. **环境变量保护**: 不要将 `.env` 文件提交到 git,在服务器上单独配置
3. **访问控制**: 配置防火墙规则,限制访问来源
4. **日志监控**: 定期检查访问日志和错误日志

## 重新构建和部署

如果修改了代码或配置,需要重新构建:

```bash
# 1. 构建生产版本
npm run build

# 2. 将 dist 目录上传到服务器
scp -r dist/* user@172.16.38.135:/path/to/dist/

# 3. 确保 nginx 配置正确
sudo nginx -t
sudo nginx -s reload
```
